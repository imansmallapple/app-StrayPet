<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Mapbox Map</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.9.2/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.9.2/mapbox-gl.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    #map { width: 100%; height: 100%; }
    .loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      color: #757575;
      font-size: 14px;
      z-index: 1000;
    }
    .loading.hidden { display: none; }
    .error {
      color: #f44336;
      text-align: center;
      padding: 20px;
    }
    .mapboxgl-popup-content {
      padding: 0;
      border-radius: 12px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      min-width: 140px;
    }
    .marker-card {
      padding: 12px 16px;
    }
    .marker-card .title {
      color: #1976D2;
      font-size: 15px;
      font-weight: 600;
      margin: 0;
      cursor: pointer;
    }
    .marker-card .title:active {
      color: #1565C0;
      text-decoration: underline;
    }
    .marker-card .desc {
      color: #757575;
      font-size: 12px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">Loading map...</div>
  <div id="map"></div>

  <script>
    // å…¨å±€å˜é‡
    var map = null;
    var markers = [];
    var mapConfig = {
      token: '',
      center: [116.4074, 39.9042],
      zoom: 10
    };

    // åˆå§‹åŒ–åœ°å›¾ - ç”±åŸç”Ÿä»£ç è°ƒç”¨
    function initMap(token, centerLng, centerLat, zoom) {
      console.log('[Map] initMap called with center:', centerLng, centerLat, 'zoom:', zoom);
      mapConfig.token = token;
      mapConfig.center = [centerLng, centerLat];
      mapConfig.zoom = zoom;

      try {
        // æ£€æŸ¥ Mapbox GL JS æ˜¯å¦åŠ è½½
        if (typeof mapboxgl === 'undefined') {
          console.error('[Map] Mapbox GL JS not loaded - check network connection');
          throw new Error('Mapbox GL JS not loaded. Please check your network connection.');
        }

        console.log('[Map] Mapbox GL JS version:', mapboxgl.version);
        mapboxgl.accessToken = token;

        // æ£€æŸ¥ WebGL æ”¯æŒ
        if (!mapboxgl.supported()) {
          console.error('[Map] WebGL not supported on this device');
          throw new Error('WebGL not supported. The map requires WebGL to render.');
        }

        console.log('[Map] WebGL supported, creating map...');
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: mapConfig.center,
          zoom: mapConfig.zoom
        });

        // æ·»åŠ å¯¼èˆªæ§ä»¶
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');

        map.on('load', function() {
          console.log('[Map] Map loaded successfully');
          document.getElementById('loading').classList.add('hidden');
        });

        // æ ·å¼åŠ è½½é”™è¯¯å¤„ç†
        map.on('style.load', function() {
          console.log('[Map] Style loaded successfully');
        });

        // ç‚¹å‡»åœ°å›¾å…¶ä»–åœ°æ–¹å…³é—­æ‰€æœ‰å¼¹çª—
        map.on('click', function(e) {
          // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ ‡è®°
          var clickedOnMarker = false;
          var features = map.queryRenderedFeatures(e.point);
          // å¦‚æœä¸æ˜¯ç‚¹å‡»æ ‡è®°ï¼Œå…³é—­æ‰€æœ‰å¼¹çª—
          closeAllPopups();
        });

        map.on('error', function(e) {
          var errMsg = e.error ? e.error.message : (e.message || 'Unknown error');
          console.error('[Map] Map error:', errMsg);
          // å¦‚æœæ˜¯è®¤è¯é”™è¯¯æˆ–ç½‘ç»œé”™è¯¯ï¼Œæ˜¾ç¤ºç»™ç”¨æˆ·
          if (errMsg.includes('401') || errMsg.includes('403')) {
            document.getElementById('loading').innerHTML = '<div class="error">Invalid Mapbox token</div>';
          }
        });

        // è¶…æ—¶æ£€æµ‹ - 10ç§’
        setTimeout(function() {
          var loading = document.getElementById('loading');
          if (loading && !loading.classList.contains('hidden')) {
            console.warn('[Map] Map loading timeout - network may be slow');
            loading.innerHTML = '<div class="error">Loading slow... Check network connection</div>';
          }
        }, 10000);

        return 'success';
      } catch (err) {
        console.error('[Map] Init error:', err.message);
        document.getElementById('loading').innerHTML = '<div class="error">' + err.message + '</div>';
        return 'error: ' + err.message;
      }
    }

    // æ·»åŠ å•ä¸ªæ ‡è®°
    function addMarker(id, lng, lat, title, description, color, imageUrl) {
      if (!map) {
        console.warn('[Map] Map not initialized');
        return;
      }

      // åˆ›å»ºå¡ç‰‡å¼å¼¹çª—ï¼Œåå­—å¯ç‚¹å‡»
      var popupHtml = '<div class="marker-card">';
      popupHtml += '<p class="title" onclick="onMarkerClick(' + id + ')">' + escapeHtml(title) + '</p>';
      if (description && description.length > 0) {
        popupHtml += '<div class="desc">' + escapeHtml(description) + '</div>';
      }
      popupHtml += '</div>';

      var popup = new mapboxgl.Popup({ offset: 25, closeButton: false, closeOnClick: true }).setHTML(popupHtml);

      var marker;
      
      console.log('[Map] Creating marker with imageUrl:', imageUrl ? imageUrl.substring(0, 100) : 'none');
      
      // å¦‚æœæœ‰å›¾ç‰‡URLï¼Œä½¿ç”¨è‡ªå®šä¹‰å›¾ç‰‡æ ‡è®°
      if (imageUrl && imageUrl.length > 0) {
        // æ ¹æ®é¢œè‰²å‚æ•°è®¾ç½®è¾¹æ¡†é¢œè‰² (Lost=çº¢è‰², Found=ç»¿è‰²)
        var borderColor = color || '#F44336';  // é»˜è®¤çº¢è‰² (Lost)
        
        // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°å…ƒç´  - ç±»ä¼¼Googleåœ°å›¾é£æ ¼çš„åœ†å½¢å¤´åƒ
        var el = document.createElement('div');
        el.className = 'custom-marker';
        el.style.cssText = 'width: 50px; height: 50px; border-radius: 50%; border: 3px solid ' + borderColor + '; background-color: ' + borderColor + '; overflow: hidden; cursor: pointer; box-shadow: 0 3px 8px rgba(0,0,0,0.4);';
        
        // æ˜¾ç¤ºé»˜è®¤å›¾æ ‡ï¼Œå›¾ç‰‡åŠ è½½æˆåŠŸåæ›¿æ¢
        el.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:white;font-size:22px;">ğŸ¾</div>';
        
        var img = new Image();
        img.onload = function() {
          // å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œæ›¿æ¢å†…å®¹
          console.log('[Map] Image loaded successfully for marker:', id);
          el.style.backgroundColor = 'white';
          el.innerHTML = '';
          img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
          el.appendChild(img);
        };
        img.onerror = function() {
          // å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œä¿æŒé»˜è®¤å›¾æ ‡
          console.log('[Map] Image load failed for marker:', id, 'url:', imageUrl);
        };
        img.src = imageUrl;
        
        marker = new mapboxgl.Marker({ element: el, anchor: 'center' })
          .setLngLat([lng, lat])
          .setPopup(popup)
          .addTo(map);
      } else {
        // ä½¿ç”¨é»˜è®¤é¢œè‰²æ ‡è®°
        marker = new mapboxgl.Marker({ color: color || '#FF6B35' })
          .setLngLat([lng, lat])
          .setPopup(popup)
          .addTo(map);
      }

      // ç‚¹å‡»æ ‡è®°æ—¶ï¼Œå…ˆå…³é—­å…¶ä»–æ‰€æœ‰å¼¹çª—
      marker.getElement().addEventListener('click', function(e) {
        e.stopPropagation();
        closeAllPopups();
        marker.togglePopup();
      });

      markers.push({ id: id, marker: marker });
      console.log('[Map] Marker added:', id, title);
    }

    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // æ ‡è®°ç‚¹å‡»å›è°ƒ - é€šè¿‡ console.log é€šçŸ¥åŸç”Ÿä»£ç 
    function onMarkerClick(markerId) {
      console.log('[MarkerClick]:' + markerId);
    }

    // å…³é—­æ‰€æœ‰å¼¹çª—
    function closeAllPopups() {
      for (var i = 0; i < markers.length; i++) {
        var popup = markers[i].marker.getPopup();
        if (popup && popup.isOpen()) {
          popup.remove();
        }
      }
    }

    // æ·»åŠ å¤šä¸ªæ ‡è®°ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
    function addMarkers(markersJson) {
      if (!map) {
        console.warn('[Map] Map not initialized');
        return;
      }

      try {
        var data = JSON.parse(markersJson);
        for (var i = 0; i < data.length; i++) {
          var m = data[i];
          addMarker(m.id, m.longitude, m.latitude, m.title, m.description || '', m.color || '#FF6B35', m.imageUrl || '');
        }

        // å¦‚æœæœ‰å¤šä¸ªæ ‡è®°ï¼Œè‡ªåŠ¨è°ƒæ•´è§†é‡
        if (data.length > 1) {
          var bounds = new mapboxgl.LngLatBounds();
          for (var j = 0; j < data.length; j++) {
            bounds.extend([data[j].longitude, data[j].latitude]);
          }
          map.fitBounds(bounds, { padding: 50 });
        }
      } catch (e) {
        console.error('[Map] Parse markers error:', e.message);
      }
    }

    // æ¸…é™¤æ‰€æœ‰æ ‡è®°
    function clearMarkers() {
      for (var i = 0; i < markers.length; i++) {
        markers[i].marker.remove();
      }
      markers = [];
      console.log('[Map] All markers cleared');
    }

    // é£è¡Œåˆ°æŒ‡å®šä½ç½®
    function flyTo(lng, lat, zoom) {
      if (!map) return;
      map.flyTo({
        center: [lng, lat],
        zoom: zoom || 14,
        essential: true
      });
    }

    // è®¾ç½®ä¸­å¿ƒç‚¹
    function setCenter(lng, lat) {
      if (!map) return;
      map.setCenter([lng, lat]);
    }

    // è®¾ç½®ç¼©æ”¾çº§åˆ«
    function setZoom(zoom) {
      if (!map) return;
      map.setZoom(zoom);
    }

    // è·å–åœ°å›¾çŠ¶æ€
    function getMapStatus() {
      return JSON.stringify({
        initialized: !!map,
        center: map ? map.getCenter() : null,
        zoom: map ? map.getZoom() : null,
        markerCount: markers.length
      });
    }

    // é¡µé¢åŠ è½½å®Œæˆåå‘é€å°±ç»ªæ¶ˆæ¯
    window.onload = function() {
      console.log('[Map] Page ready, waiting for initMap call');
    };
  </script>
</body>
</html>
